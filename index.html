<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Family Cheese - Натуральні сири</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
:root {
    --primary-color: #D4935A;
    --primary-dark: #A0703E;
    --primary-light: #E8B17A;
    --accent: #F2C98A;
    --success: #27AE60;
    --error: #E74C3C;
    --bg-primary: #FFF9F4;
    --bg-secondary: #F8F3ED;
    --bg-card: #FFFFFF;
    --text-primary: #2C1810;
    --text-secondary: #5D3A24;
    --border-color: #E6D5C7;
    --shadow: 0 2px 8px rgba(212, 147, 90, 0.1);
    --shadow-lg: 0 8px 20px rgba(212, 147, 90, 0.15);
    --gradient: linear-gradient(135deg, #F2C98A 0%, #D4935A 100%);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; font-size: 16px; }
body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
}

/* HEADER */
.header {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: rgba(255, 249, 244, 0.98);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    padding: 1rem 0;
}

.header-content {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0 1rem;
    max-width: 1200px;
    margin: 0 auto;
}

.logo {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
    font-family: 'Comfortaa', sans-serif;
    white-space: nowrap;
}

.search-container {
    flex-grow: 1;
    position: relative;
}

.search-input {
    width: 100%;
    padding: 0.7rem 1rem 0.7rem 2.5rem;
    border: 1.5px solid var(--border-color);
    border-radius: 20px;
    font-size: 0.95rem;
    background: var(--bg-secondary);
    color: var(--text-primary);
    transition: all 0.3s ease;
}

.search-input::placeholder {
    color: var(--text-secondary);
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    background: var(--bg-card);
    box-shadow: 0 0 0 3px rgba(212, 147, 90, 0.1);
}

.search-icon {
    position: absolute;
    left: 0.8rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 1rem;
    pointer-events: none;
}

.cart-badge {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: var(--gradient);
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: var(--shadow-lg);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.cart-badge:active {
    transform: scale(0.95);
}

.cart-badge:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 16px rgba(212, 147, 90, 0.2);
}

.cart-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--error);
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 700;
    border: 2px solid var(--bg-primary);
}

.cart-count.hidden {
    display: none;
}

/* PROMO */
.promo-section {
    padding: 1rem;
    margin-top: -0.5rem;
}

.promo-box {
    background: var(--gradient);
    color: white;
    padding: 1.2rem 1.5rem;
    border-radius: 16px;
    text-align: center;
    position: relative;
    box-shadow: var(--shadow-lg);
    font-weight: 600;
    font-size: 0.95rem;
    line-height: 1.5;
}

.promo-box strong {
    font-size: 1.1rem;
    display: block;
    margin: 0.3rem 0;
}

.promo-close {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.promo-close:active {
    background: rgba(255, 255, 255, 0.4);
}

/* CONTAINER */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem 2rem;
}

.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    gap: 1rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* PRODUCT LIST */
.product-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-top: 1.5rem;
}

.product-card {
    background: var(--bg-card);
    border-radius: 14px;
    overflow: hidden;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    display: flex;
    flex-direction: column;
}

.product-card:active {
    transform: scale(0.98);
}

.product-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.gallery-image {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    background: var(--bg-secondary);
}

.product-info {
    padding: 1rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.title {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 0.4rem;
    line-height: 1.3;
    color: var(--text-primary);
}

.weight {
    color: var(--text-secondary);
    font-size: 0.8rem;
    margin-bottom: 0.6rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.price-container {
    display: flex;
    align-items: baseline;
    gap: 0.6rem;
    margin-bottom: 0.8rem;
    margin-top: auto;
}

.current-price {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary-color);
}

.original-price {
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-decoration: line-through;
}

.card-footer {
    display: flex;
    align-items: center;
    gap: 0.6rem;
}

.add-to-cart-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: var(--gradient);
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.add-to-cart-btn:active {
    transform: scale(0.9);
}

.add-to-cart-btn:hover {
    transform: scale(1.1);
    box-shadow: var(--shadow-lg);
}

.quantity-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 0.3rem;
    flex-shrink: 0;
}

.quantity-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background: var(--primary-color);
    color: white;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

.quantity-btn:active {
    transform: scale(0.9);
}

.quantity-btn:hover {
    background: var(--primary-dark);
}

.quantity {
    font-weight: 700;
    min-width: 20px;
    text-align: center;
    font-size: 0.9rem;
}

.details-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    font-size: 0.8rem;
    text-decoration: none;
    font-weight: 500;
    padding: 0.4rem 0.6rem;
    transition: all 0.2s ease;
    margin-left: auto;
}

.details-btn:active {
    transform: scale(0.95);
}

/* ORDER FORM */
.order-form {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-card);
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    max-height: 90vh;
    overflow-y: auto;
    z-index: 1500;
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    box-shadow: 0 -4px 20px rgba(212, 147, 90, 0.15);
    border-top: 3px solid var(--primary-color);
}

.order-form.visible {
    transform: translateY(0);
}

.order-form-content {
    padding: 2rem 1.5rem;
    position: relative;
}

.order-form h2 {
    font-family: 'Comfortaa', sans-serif;
    font-size: 1.4rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: var(--text-primary);
}

.order-form-close-btn {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 1.4rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
    z-index: 10;
}

.order-form-close-btn:active {
    transform: scale(0.9);
}

.order-form-close-btn:hover {
    background: var(--error);
    color: white;
    transform: scale(1.1);
}

.change-order-btn {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: none;
    padding: 0.8rem 1.2rem;
    border-radius: 12px;
    cursor: pointer;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
    font-weight: 600;
    font-size: 0.95rem;
    width: 100%;
}

.change-order-btn:active {
    transform: scale(0.95);
}

.change-order-btn:hover {
    background: var(--primary-color);
    color: white;
}

.summary-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    margin-bottom: 0.8rem;
    border: 1px solid var(--border-color);
}

.summary-item-img {
    width: 56px;
    height: 56px;
    border-radius: 10px;
    object-fit: cover;
    box-shadow: var(--shadow);
}

.summary-item-details {
    flex: 1;
}

.summary-item-name {
    font-weight: 600;
    margin-bottom: 0.2rem;
    font-size: 0.9rem;
}

.summary-item-quantity {
    color: var(--text-secondary);
    font-size: 0.8rem;
}

.summary-item-price {
    font-weight: 700;
    color: var(--primary-color);
    font-size: 1rem;
}

.summary-totals {
    background: var(--bg-secondary);
    border-radius: 14px;
    padding: 1.2rem;
    margin: 1.5rem 0;
    border: 1px solid var(--border-color);
}

.summary-totals > div {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.6rem;
    font-size: 0.95rem;
}

.total-price {
    font-weight: 700;
    font-size: 1.2rem;
    color: var(--primary-color);
    border-top: 2px solid var(--border-color);
    padding-top: 0.8rem;
    margin-top: 0.8rem;
}

.total-discount {
    color: var(--success);
    font-weight: 600;
}

.delivery-options {
    margin-bottom: 1.5rem;
}

.delivery-options h2 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.delivery-option {
    display: flex;
    align-items: center;
    padding: 1rem;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    margin-bottom: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.delivery-option:active {
    transform: scale(0.98);
}

.delivery-option:hover,
.delivery-option input:checked + label + .price {
    border-color: var(--primary-color);
    background: rgba(212, 147, 90, 0.05);
}

.delivery-option input[type="radio"] {
    margin-right: 1rem;
    transform: scale(1.2);
    accent-color: var(--primary-color);
    cursor: pointer;
}

.delivery-option label {
    flex: 1;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
}

.delivery-option label b {
    display: block;
    margin-bottom: 0.2rem;
}

.delivery-option .price {
    font-weight: 700;
    color: var(--primary-color);
}

.address-field {
    margin-bottom: 1.5rem;
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition: all 0.3s ease;
}

.address-field.visible {
    opacity: 1;
    max-height: 100px;
}

.form-group {
    margin-bottom: 1.2rem;
}

.form-group input,
.address-field input {
    width: 100%;
    padding: 1rem;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    font-size: 1rem;
    background: var(--bg-primary);
    color: var(--text-primary);
    transition: all 0.3s ease;
    font-family: 'Comfortaa', sans-serif;
}

.form-group input::placeholder,
.address-field input::placeholder {
    color: var(--text-secondary);
}

.form-group input:focus,
.address-field input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(212, 147, 90, 0.1);
    background: var(--bg-card);
}

.error {
    color: var(--error);
    font-size: 0.9rem;
    margin-bottom: 1rem;
    text-align: center;
    font-weight: 500;
}

.order-notice {
    background: rgba(212, 147, 90, 0.08);
    border: 1.5px solid rgba(212, 147, 90, 0.2);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
}

.order-notice i {
    color: var(--primary-color);
    font-size: 1.1rem;
    flex-shrink: 0;
}

/* MODAL */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(44, 24, 16, 0.6);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    padding: 1rem;
}

.modal-backdrop.visible {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: var(--bg-card);
    border-radius: 16px;
    max-width: 500px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(212, 147, 90, 0.2);
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.modal-backdrop.visible .modal-content {
    transform: scale(1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-secondary);
}

.modal-title {
    font-family: 'Comfortaa', sans-serif;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.4rem;
    cursor: pointer;
    color: var(--text-secondary);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.modal-close:hover {
    background: var(--bg-tertiary);
    transform: rotate(90deg);
}

.modal-body {
    padding: 1.5rem;
    line-height: 1.7;
    color: var(--text-secondary);
    font-size: 0.95rem;
}

/* INFO SECTIONS */
.info-section {
    padding: 2rem 0;
    margin-top: 2rem;
}

.section-title {
    text-align: center;
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: var(--text-primary);
}

.about-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    text-align: center;
}

.about-image img {
    width: 100%;
    border-radius: 14px;
    box-shadow: var(--shadow-lg);
}

.about-text h3 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.about-text p {
    color: var(--text-secondary);
    line-height: 1.7;
    font-size: 0.95rem;
}

.reviews-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.2rem;
}

.review-card {
    background: var(--bg-card);
    padding: 1.2rem;
    border-radius: 14px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}

.review-header {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 1rem;
}

.review-header .fa-user-circle {
    font-size: 2.5rem;
    color: var(--primary-color);
    flex-shrink: 0;
}

.reviewer-name {
    font-weight: 600;
    font-size: 0.95rem;
}

.review-stars {
    color: #F39C12;
    font-size: 0.9rem;
}

.review-text {
    color: var(--text-secondary);
    font-style: italic;
    font-size: 0.9rem;
    line-height: 1.6;
}

/* RESPONSIVE */
@media (min-width: 600px) {
    .reviews-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 768px) {
    .header {
        padding: 1.2rem 0;
    }
    
    .header-content {
        gap: 1.5rem;
        padding: 0 1.5rem;
    }

    .search-input {
        padding: 0.8rem 1.2rem 0.8rem 2.8rem;
        border-radius: 24px;
    }

    .container {
        padding: 0 1.5rem 3rem;
    }

    .product-list {
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .section-title {
        font-size: 2rem;
    }

    .about-content {
        grid-template-columns: 1fr 1.5fr;
        text-align: left;
        gap: 2rem;
    }
}

@media (min-width: 1024px) {
    .product-list {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 2rem;
    }

    .reviews-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

.hidden {
    display: none !important;
}
</style>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>
  <header class="header">
    <div class="header-content">
        <div class="logo">🧀 Family</div>
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Пошук сирів..." id="search-input">
        </div>
        <button class="cart-badge" id="cart-badge" title="Кошик">
            <span class="cart-count hidden" id="cart-count">0</span>
            <i class="fas fa-shopping-cart"></i>
        </button>
    </div>
</header>

<section class="promo-section" id="promo-section">
  <div class="container">
    <div class="promo-box">
      🎉 <strong>15% на всі сири</strong>
      + доставка по Обухову <strong>1 грн</strong>
      <br><small style="opacity: 0.9;">Тільки цього тижня!</small>
      <button class="promo-close" id="promo-close"><i class="fas fa-times"></i></button>
    </div>
  </div>
</section>

<div class="container">
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>Завантаження...</span>
    </div>
    <div class="product-list" id="product-list"></div>
</div>

<section id="reviews" class="info-section">
    <div class="container">
        <h2 class="section-title">Відгуки клієнтів</h2>
        <div class="reviews-grid">
            <div class="review-card">
                <div class="review-header">
                    <i class="fas fa-user-circle"></i>
                    <div>
                        <p class="reviewer-name">Олена П.</p>
                        <div class="review-stars"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></div>
                    </div>
                </div>
                <p class="review-text">"Неймовірно смачний сир! Гауда просто тане в роті. Відчувається натуральність. Обов'язково замовлю ще!"</p>
            </div>
            <div class="review-card">
                <div class="review-header">
                    <i class="fas fa-user-circle"></i>
                    <div>
                        <p class="reviewer-name">Андрій</p>
                        <div class="review-stars"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i></div>
                    </div>
                </div>
                <p class="review-text">"Замовляв по Обухову, привезли швидко. Сир свіжий і ароматний. Якість того варта!"</p>
            </div>
        </div>
    </div>
</section>

<section id="about-us" class="info-section">
    <div class="container">
        <h2 class="section-title">Про Нас</h2>
        <div class="about-content">
            <div class="about-image">
                <img src="data/pro_nas.png" alt="Наша сироварня" onerror="this.style.display='none'">
            </div>
            <div class="about-text">
                <h3>Сімейна справа з любов'ю</h3>
                <p><strong>Family Cheese</strong> — невелика сімейна сироварня, де створюють натуральні сири за традиційними рецептами. Кожна головка — результат ручної праці, якісного молока та пристрасті до сироваріння.</p>
            </div>
        </div>
    </div>
</section>

<div class="modal-backdrop" id="description-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title"></h2>
            <button class="modal-close" id="modal-close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<div id="order-form" class="order-form">
    <div class="order-form-content">
        <h2>Ваше замовлення</h2>
        <button class="order-form-close-btn" id="order-form-close-btn" title="Закрити"><i class="fas fa-times"></i></button>
        
        <div id="order-summary"></div>
        
        <div class="order-notice">
            <i class="fas fa-info-circle"></i>
            Після зважування сума стане меншою!
        </div>

        <button class="change-order-btn"><i class="fas fa-edit"></i> Змінити замовлення</button>

        <div class="delivery-options">
            <h2>Спосіб доставки</h2>
            <div class="delivery-option">
                <input type="radio" id="obukhiv-delivery" name="delivery" value="1" data-title="Доставка по м. Обухів" checked>
                <label for="obukhiv-delivery"><b>Доставка по м. Обухів</b></label>
                <span class="price">1 грн</span>
            </div>
            <div class="delivery-option">
                <input type="radio" id="obukhiv-nova-poshta" name="delivery" value="1" data-title="Доставка Нова пошта м. Обухів">
                <label for="obukhiv-nova-poshta"><b>Нова пошта у м. Обухів</b><br><small style="font-size: 0.8rem;">або поштомат</small></label>
                <span class="price">1 грн</span>
            </div>
            <div class="delivery-option">
                <input type="radio" id="nova-poshta" name="delivery" value="0" data-title="Нова Пошта по Україні">
                <label for="nova-poshta"><b>Нова пошта по Україні</b><br><small style="font-size: 0.8rem;">за тарифами перевізника</small></label>
            </div>
        </div>

        <div id="address-field-container" class="address-field visible">
            <input type="text" id="address-input" placeholder="Введіть адресу або № відділення">
        </div>

        <h2>Контактні дані</h2>
        <p class="error" id="form-error"></p>
        <div class="form-group">
            <input type="text" id="user-name" placeholder="Ім'я та Прізвище">
        </div>
        <div class="form-group">
            <input type="tel" id="user-phone" placeholder="0 XX XXX XX XX">
        </div>

        <div class="order-notice">
            <i class="fas fa-credit-card"></i>
            Оплата після отримання
        </div>
    </div>
</div>

<script type="module">
    const AppState = {
        products: [],
        cart: {},
        isFormVisible: false,
        tg: null,
    };

    const elements = {
        loading: document.getElementById('loading'),
        productList: document.getElementById('product-list'),
        searchInput: document.getElementById('search-input'),
        cartBadge: document.getElementById('cart-badge'),
        cartCount: document.getElementById('cart-count'),
        promoSection: document.getElementById('promo-section'),
        promoCloseBtn: document.getElementById('promo-close'),
        orderForm: document.getElementById('order-form'),
        orderFormCloseBtn: document.getElementById('order-form-close-btn'),
        changeOrderBtn: document.querySelector('.change-order-btn'),
        deliveryOptions: document.querySelectorAll('input[name="delivery"]'),
        addressContainer: document.getElementById('address-field-container'),
        orderSummary: document.getElementById('order-summary'),
        userNameInput: document.getElementById("user-name"),
        userPhoneInput: document.getElementById("user-phone"),
        addressInput: document.getElementById("address-input"),
        formError: document.getElementById("form-error"),
        modal: document.getElementById('description-modal'),
        modalTitle: document.getElementById('modal-title'),
        modalBody: document.getElementById('modal-body'),
        modalCloseBtn: document.getElementById('modal-close-btn'),
    };

    function createProductElement(product) {
        const card = document.createElement("div");
        card.className = "product-card";
        card.dataset.id = product.id;

        const priceHTML = product.original_price
            ? `<span class="current-price">${product.price.toFixed(2)} грн</span><span class="original-price">${product.original_price.toFixed(2)} грн</span>`
            : `<span class="current-price">${product.price.toFixed(2)} грн</span>`;

        card.innerHTML = `
            <img src="${product.images[0]}" alt="${product.name}" class="gallery-image" onerror="this.onerror=null;this.src='https://placehold.co/300x300/E8B17A/8B4513?text=${encodeURIComponent(product.name)}';"/>
            <div class="product-info">
                <div class="title">${product.name}</div>
                <div class="weight"><i class="fas fa-cube"></i> ${product.weight}</div>
                <div class="price-container">${priceHTML}</div>
                <div class="card-footer">
                    <button class="add-to-cart-btn" title="Додати в кошик"><i class="fas fa-plus"></i></button>
                    <div class="quantity-control" style="display: none;">
                        <button class="quantity-btn" data-action="decrease"><i class="fas fa-minus"></i></button>
                        <span class="quantity">1</span>
                        <button class="quantity-btn" data-action="increase"><i class="fas fa-plus"></i></button>
                    </div>
                    <button class="details-btn" data-title="${product.name}" data-description="${product.description.replace(/"/g, '&quot;')}"><i class="fas fa-circle-info"></i></button>
                </div>
            </div>`;
        return card;
    }

    function updateCart(productId, action) {
        const product = AppState.products.find(p => p.id == productId);
        if (!product) return;

        if (action === 'add' && !AppState.cart[productId]) {
            AppState.cart[productId] = { name: product.name, price: product.price, quantity: 1 };
        } else if (action === 'increase' && AppState.cart[productId]) {
            AppState.cart[productId].quantity++;
        } else if (action === 'decrease' && AppState.cart[productId]) {
            AppState.cart[productId].quantity--;
            if (AppState.cart[productId].quantity <= 0) {
                delete AppState.cart[productId];
            }
        }
        updateUI();
    }

    function openOrderForm() {
        AppState.isFormVisible = true;
        renderOrderSummary();
        elements.orderForm.classList.add("visible");
        AppState.tg?.BackButton.show();
        updateUI();
    }

    function closeOrderForm() {
        AppState.isFormVisible = false;
        elements.orderForm.classList.remove("visible");
        AppState.tg?.BackButton.hide();
        updateUI();
    }

    function renderOrderSummary() {
        if (!elements.orderSummary) return;

        let itemsHTML = "";
        let productsTotal = 0;
        let totalDiscount = 0;

        for (const id in AppState.cart) {
            const product = AppState.products.find(p => p.id == id);
            const item = AppState.cart[id];
            if (!product) continue;

            const itemTotalPrice = item.price * item.quantity;
            productsTotal += itemTotalPrice;

            if (product.original_price) {
                totalDiscount += (product.original_price - item.price) * item.quantity;
            }

            itemsHTML += `
                <div class="summary-item">
                    <img src="${product.images[0]}" alt="${item.name}" class="summary-item-img" onerror="this.onerror=null;this.src='https://placehold.co/56x56/E8B17A/8B4513?text=🧀';">
                    <div class="summary-item-details">
                        <div class="summary-item-name">${item.name}</div>
                        <div class="summary-item-quantity">${item.quantity} × ${item.price.toFixed(2)} грн</div>
                    </div>
                    <div class="summary-item-price">${itemTotalPrice.toFixed(2)} грн</div>
                </div>`;
        }

        const selectedDelivery = document.querySelector('input[name="delivery"]:checked');
        const deliveryCost = parseInt(selectedDelivery ? selectedDelivery.value : "0", 10) || 0;
        const finalTotal = productsTotal + deliveryCost;

        const totalsHTML = `
            <div class="summary-totals">
                ${totalDiscount > 0 ? `<div class="total-discount"><span><i class="fas fa-tag"></i> Знижка:</span><span>-${totalDiscount.toFixed(2)} грн</span></div>` : ""}
                ${deliveryCost > 0 ? `<div><span><i class="fas fa-truck"></i> Доставка:</span><span>${deliveryCost.toFixed(2)} грн</span></div>` : ""}
                <div class="total-price"><span>Разом:</span><span>${finalTotal.toFixed(2)} грн</span></div>
            </div>`;

        elements.orderSummary.innerHTML = itemsHTML + totalsHTML;
    }

    function initializeTelegramWebApp() {
        try {
            AppState.tg = window.Telegram?.WebApp;
            if (AppState.tg) {
                AppState.tg.ready();
                AppState.tg.expand();
            } else {
                AppState.tg = {
                    initData: 'dev_mode',
                    initDataUnsafe: { user: { id: 'test', first_name: 'Test', last_name: 'User' } },
                    MainButton: {
                        setText: () => {},
                        show: () => {},
                        hide: () => {},
                        setParams: () => {},
                    },
                    BackButton: {
                        show: () => {},
                        hide: () => {},
                    },
                    onEvent: () => {},
                    close: () => {},
                    showAlert: (msg) => alert(msg),
                };
            }
        } catch (e) {
            console.warn('TG init error:', e);
        }
    }

    const API_URLS = {
        PRODUCTS: './data/products.json',
        SUBMIT_ORDER: 'https://urfine.com.ua/fct/hs/bots/order/'
    };

    async function loadProducts() {
        elements.loading.style.display = 'flex';
        try {
            const response = await fetch(API_URLS.PRODUCTS);
            if (!response.ok) throw new Error('Network error');
            AppState.products = await response.json();
        } catch (error) {
            console.error('Load error:', error);
            AppState.products = [];
        } finally {
            elements.loading.style.display = 'none';
        }
    }

    function validateOrderForm() {
        elements.formError.textContent = "";

        if (elements.userNameInput.value.trim().length < 3) {
            elements.formError.textContent = "Введіть ім'я та прізвище";
            return null;
        }

        if (!/^\+?3?8?(0\d{9})$/.test(elements.userPhoneInput.value.replace(/\s/g, ""))) {
            elements.formError.textContent = "Введіть телефон";
            return null;
        }

        let rawTotalPrice = 0;
        let rawTotalDiscount = 0;
        const cartAsArray = Object.keys(AppState.cart).map(id => {
            const product = AppState.products.find(p => p.id == id);
            const item = AppState.cart[id];
            rawTotalPrice += item.price * item.quantity;
            if (product?.original_price) {
                rawTotalDiscount += (product.original_price - item.price) * item.quantity;
            }
            return { id, ...item };
        });

        const selectedDelivery = document.querySelector('input[name="delivery"]:checked');
        const deliveryData = {
            id: selectedDelivery.id,
            cost: parseInt(selectedDelivery.value, 10) || 0,
            address: elements.addressInput.value
        };

        return {
            userId: AppState.tg.initDataUnsafe?.user?.id || 'user',
            user: { name: elements.userNameInput.value, phone: elements.userPhoneInput.value },
            cart: cartAsArray,
            totalPrice: (rawTotalPrice + deliveryData.cost).toFixed(2),
            totalDiscount: rawTotalDiscount.toFixed(2),
            delivery: deliveryData
        };
    }

    function submitOrder() {
        const orderData = validateOrderForm();
        if (!orderData) return;
        
        AppState.tg.showAlert('Замовлення прийнято!');
        AppState.tg.close();
        
        fetch(API_URLS.SUBMIT_ORDER, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
        }).catch(e => console.error('Order error:', e));
    }

    function renderProducts() {
        const query = elements.searchInput.value.toLowerCase();
        const filtered = AppState.products.filter(p =>
            p.name.toLowerCase().includes(query) || p.description.toLowerCase().includes(query)
        );

        elements.productList.innerHTML = "";
        if (filtered.length === 0) {
            elements.productList.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--text-secondary);">Товари не знайдено</div>`;
            return;
        }
        filtered.forEach(product => {
            elements.productList.appendChild(createProductElement(product));
        });
    }

    function updateCartControls() {
        document.querySelectorAll('.product-card').forEach(card => {
            const id = card.dataset.id;
            const addBtn = card.querySelector('.add-to-cart-btn');
            const quantityControl = card.querySelector('.quantity-control');
            
            if (AppState.cart[id]) {
                addBtn.style.display = 'none';
                quantityControl.style.display = 'flex';
                quantityControl.querySelector('.quantity').textContent = AppState.cart[id].quantity;
            } else {
                addBtn.style.display = 'flex';
                quantityControl.style.display = 'none';
            }
        });
    }

    function updateMainButton() {
        const totalItems = Object.values(AppState.cart).reduce((sum, item) => sum + item.quantity, 0);
        if (totalItems > 0) {
            const text = AppState.isFormVisible ? 'Надіслати' : `Кошик (${totalItems})`;
            AppState.tg.MainButton.setText(text);
            AppState.tg.MainButton.show();
        } else {
            AppState.tg.MainButton.hide();
            if (AppState.isFormVisible) closeOrderForm();
        }
    }

    function updateUI() {
        renderProducts();
        updateCartControls();
        const totalItems = Object.values(AppState.cart).reduce((sum, item) => sum + item.quantity, 0);
        elements.cartCount.textContent = totalItems;
        elements.cartCount.classList.toggle('hidden', totalItems === 0);
        if (AppState.tg) updateMainButton();
    }

    function showProductDetailsModal(title, description) {
        elements.modalTitle.textContent = title;
        elements.modalBody.innerHTML = description.replace(/\n/g, '<br>');
        elements.modal.classList.add('visible');
        AppState.tg?.BackButton.show();
    }

    function closeProductDetailsModal() {
        elements.modal.classList.remove('visible');
        if (!AppState.isFormVisible) AppState.tg?.BackButton.hide();
    }

    function handleProductClick(e) {
        const card = e.target.closest('.product-card');
        if (!card) return;

        const productId = card.dataset.id;
        
        if (e.target.closest('.add-to-cart-btn')) {
            updateCart(productId, 'add');
        } else if (e.target.closest('.quantity-btn')) {
            const action = e.target.closest('.quantity-btn').dataset.action;
            updateCart(productId, action);
        } else if (e.target.closest('.details-btn')) {
            const btn = e.target.closest('.details-btn');
            showProductDetailsModal(btn.dataset.title, btn.dataset.description);
        }
    }

    function initEventListeners() {
        elements.cartBadge.addEventListener('click', () => {
            if (Object.keys(AppState.cart).length > 0) openOrderForm();
        });
        elements.changeOrderBtn?.addEventListener('click', closeOrderForm);
        elements.orderFormCloseBtn?.addEventListener('click', closeOrderForm);
        elements.searchInput.addEventListener('input', () => updateUI());
        elements.productList.addEventListener('click', handleProductClick);
        elements.deliveryOptions.forEach(opt => {
            opt.addEventListener('change', renderOrderSummary);
        });
        elements.modalCloseBtn.addEventListener('click', closeProductDetailsModal);
        elements.modal.addEventListener('click', (e) => {
            if (e.target === elements.modal) closeProductDetailsModal();
        });
        elements.promoCloseBtn.addEventListener('click', () => {
            elements.promoSection.style.display = 'none';
        });

        if (AppState.tg) {
            AppState.tg.onEvent('backButtonClicked', () => {
                if (elements.modal.classList.contains('visible')) closeProductDetailsModal();
                else if (AppState.isFormVisible) closeOrderForm();
            });
            AppState.tg.onEvent('mainButtonClicked', () => {
                if (!AppState.isFormVisible) openOrderForm();
                else submitOrder();
            });
        }
    }

    function initApp() {
        initializeTelegramWebApp();
        initEventListeners();
        loadProducts().then(() => updateUI());
    }

    document.addEventListener('DOMContentLoaded', initApp);
</script>